Spring orm

persistence context
    это сессионный кеш первого уровня для объектов которые сохраняются и загружаются
        в\из бд в рамках сессии\транзакции
    сущность может находится в трех состояниях
        transient
            объект ниразу не был присоединен к контексту, то есть это новый объект для
                контекста и бд
        persistent
            объект находится под управлением persistence context,
                изменения в объекте будут оборажены в бд
        detached
            объект когда то был в прикреплен к контексту
            попадает в это состояние если исключить его из контекста,
                очистить или закрыть сессию

EntityManager
    создается как бин в spring orm, без спринга конфиг берется из persistence.xml
    внедряется через @PersistenceContext в репозиторий
    отвечает за все операции над сущностями
    методы и их значения:
        find()
            поиск и загрузка сущности в persistence context
            сущность получает состояни persistent

        persist()
            прикрепляет сущность у контексту, после чего делает сохранение в базу(не сразу)
            id для сущности будет гарантированно назначен после завершения транзакции(может и сразу)
            может кинуть PersistentObjectException, значит объект не считается новым,
                например если задан у сущности id

        merge()
            меняет состояние объекта из transient\detached в persistent
            для transient как persist()
            для detached выполнит загрузки из бд, обновление в контексте, и обновит в бд
                по завершении тразакции или сессии

        remove()
            удаление сущности из контекста и базы, из persistent в transient
            сущность должна быть persistent, иначе будет IllegalArgumentException

        refresh()
            обновление сущности в контексте, есл она была изменена в другой сессии
                после выгрузки из базы в контекст

        detach()
            отключает объект от контекста, не удаляет из базы. из persistent в detached

        createQuery()
            создание запроса через jpql
            query бывает typed(приоритет использования)
            jpql работает с агрегациями
            jpql запросы очень мощный инструмент
                прямо в запросе jpql можно сделать агрегацию в java объект из
                полей сущности и вернуть его в качестве ответа

        uptach()
            сущность из detached в persistent

        lock()
            блокировка, писсимистичная, есть еще version(оптимистичная)


